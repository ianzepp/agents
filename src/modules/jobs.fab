# ═══════════════════════════════════════════════════════════════════════════════
# MUNERA - Gestio Munera Agentium
# ═══════════════════════════════════════════════════════════════════════════════
#
# Commands for managing agent jobs: list, watch, logs, response, kill, clean
#
# ═══════════════════════════════════════════════════════════════════════════════

ex "../norma/hal/solum" importa solum
ex "../norma/hal/json" importa json
ex "../norma/hal/processus" importa processus

# ─────────────────────────────────────────────────────────────────────────────
# Viae - directory paths
# ─────────────────────────────────────────────────────────────────────────────

fixum RADIX_AGENTIUM = solum.iunge([solum.domus(), ".agents"])
fixum VIA_MUNERUM = solum.iunge([RADIX_AGENTIUM, "runs"])

functio viaMuneris(textus identi) -> textus {
    redde solum.iunge([VIA_MUNERUM, identi])
}

functio viaMetadatorum(textus identi) -> textus {
    redde solum.iunge([VIA_MUNERUM, identi, "run.json"])
}

functio viaExitus(textus identi) -> textus {
    redde solum.iunge([VIA_MUNERUM, identi, "output.log"])
}

functio viaResponsi(textus identi) -> textus {
    redde solum.iunge([VIA_MUNERUM, identi, "response.md"])
}

# ─────────────────────────────────────────────────────────────────────────────
# Auxiliares
# ─────────────────────────────────────────────────────────────────────────────

@ futura
functio colligeMuneraIds() -> lista<textus> {
    si non solum.exstat(VIA_MUNERUM) {
        redde [] innatum lista<textus>
    }
    redde cede solum.elenca(VIA_MUNERUM)
}

# ─────────────────────────────────────────────────────────────────────────────
# Modulum
# ─────────────────────────────────────────────────────────────────────────────

@ descriptio "Manage agent jobs"
incipit {}

# ═══════════════════════════════════════════════════════════════════════════════
# list - enumera omnia munera cum statu
# ═══════════════════════════════════════════════════════════════════════════════

@ imperium "list"
@ alias "ls"
@ descriptio "List all jobs with status"
@ futura
functio list() -> vacuum {
    fixum identitates = cede colligeMuneraIds()

    si identitates.length == 0 {
        scribe "No jobs found."
        redde
    }

    scribe "ID         REPO                           ISSUE   MODEL             STATUS"

    ex identitates pro identi {
        fixum viaMetae = viaMetadatorum(identi)
        si non solum.exstat(viaMetae) ergo perge

        fixum contentum = cede solum.lege(viaMetae)
        fixum munus = json.pange(contentum)

        fixum repositorium = munus.repo vel "(no repo)"
        fixum numerusIssue = munus.issue sic scriptum("#§", munus.issue) secus "-"
        fixum exemplar = munus.model vel "unknown"
        fixum status = munus.status vel "unknown"

        scribe scriptum("§  §  §  §  §", identi, repositorium, numerusIssue, exemplar, status)
    }
}

# ═══════════════════════════════════════════════════════════════════════════════
# watch - sequere exitum muneris in tempore reali
# ═══════════════════════════════════════════════════════════════════════════════

@ imperium "watch"
@ descriptio "Follow job output in real-time"
@ futura
functio watch(textus identi) -> vacuum {
    fixum viaExituum = viaExitus(identi)

    si non solum.exstat(viaExituum) {
        mone scriptum("Job § not found or has no output", identi)
        redde
    }

    # Sequere exitum cum tail -f
    processus.exsequi(scriptum("tail -f §", viaExituum))
}

# ═══════════════════════════════════════════════════════════════════════════════
# logs - ostende plenum muneris exitum
# ═══════════════════════════════════════════════════════════════════════════════

@ imperium "logs"
@ descriptio "Show full job log"
@ futura
functio logs(textus identi) -> vacuum {
    fixum viaExituum = viaExitus(identi)

    si non solum.exstat(viaExituum) {
        mone scriptum("Job § not found or has no output", identi)
        redde
    }

    fixum contentum = cede solum.lege(viaExituum)
    scribe contentum
}

# ═══════════════════════════════════════════════════════════════════════════════
# response - ostende responsum finale
# ═══════════════════════════════════════════════════════════════════════════════

@ imperium "response"
@ descriptio "Show final response (if completed)"
@ futura
functio response(textus identi) -> vacuum {
    fixum viaResponsum = viaResponsi(identi)

    si non solum.exstat(viaResponsum) {
        mone scriptum("Job § has no response yet", identi)
        redde
    }

    fixum contentum = cede solum.lege(viaResponsum)
    scribe contentum
}

# ═══════════════════════════════════════════════════════════════════════════════
# kill - siste munus currens
# ═══════════════════════════════════════════════════════════════════════════════

@ imperium "kill"
@ descriptio "Stop a running job"
@ futura
functio kill(textus identi) -> vacuum {
    fixum viaMetae = viaMetadatorum(identi)

    si non solum.exstat(viaMetae) {
        mone scriptum("Job § not found", identi)
        redde
    }

    fixum contentum = cede solum.lege(viaMetae)
    fixum munus = json.pange(contentum)

    si munus.status != "running" {
        mone scriptum("Job § is not running (status: §)", identi, munus.status)
        redde
    }

    # Mitte SIGTERM ad processum
    si munus.pid {
        processus.exsequi(scriptum("kill §", munus.pid))
        scribe scriptum("Sent SIGTERM to PID §", munus.pid)
    }
    secus {
        mone "Job has no PID recorded"
    }
}

# ═══════════════════════════════════════════════════════════════════════════════
# clean - remove munera vetera
# ═══════════════════════════════════════════════════════════════════════════════

@ imperium "clean"
@ descriptio "Remove old jobs"
@ optio bivalens all longum "all" descriptio "Remove all jobs"
@ optio textus olderThan longum "older-than" descriptio "Remove jobs older than (e.g., 7d, 24h)"
@ futura
functio clean(si bivalens all, si textus olderThan) -> vacuum {
    si all {
        fixum identitates = cede colligeMuneraIds()
        ex identitates pro identi {
            fixum via = viaMuneris(identi)
            processus.exsequi(scriptum("rm -rf §", via))
        }
        scribe scriptum("Removed § job(s)", identitates.length)
        redde
    }

    si olderThan {
        # TODO: parse age string, remove matching jobs
        scribe scriptum("TODO: clean jobs older than §", olderThan)
        redde
    }

    mone "Specify --all or --older-than <age>"
}
