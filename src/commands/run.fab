# ═══════════════════════════════════════════════════════════════════════════════
# CURRE - Genera Novum Munus Agentis
# ═══════════════════════════════════════════════════════════════════════════════
#
# The main command that spawns an isolated agent process:
#
#   1. Generates unique job ID
#   2. Creates isolated HOME directory with credentials
#   3. Sets up git worktree from bare repo (if --repo specified)
#   4. Installs dependencies (bun install)
#   5. Assembles prompt with optional persona
#   6. Spawns agent process with PTY via `script`
#
# ═══════════════════════════════════════════════════════════════════════════════

ex "../norma/hal/aleator" importa aleator
ex "../norma/hal/json" importa json
ex "../norma/hal/processus" importa processus
ex "../norma/hal/solum" importa solum

# ═══════════════════════════════════════════════════════════════════════════════
# VIAE - Directory structure
# ═══════════════════════════════════════════════════════════════════════════════
#
# ~/.agents/
#   runs/           Job directories (one per run)
#     <id>/
#       home/       Isolated HOME for agent
#       repo/       Git worktree (if --repo)
#       output.log  PTY output capture
#       run.json    Job metadata
#   repos/          Bare git repos (shared across runs)
#   personas/       Persona markdown files
#
# ═══════════════════════════════════════════════════════════════════════════════

fixum RADIX_AGENTIUM = solum.iunge([solum.domus(), ".agents"])
fixum VIA_MUNERUM = solum.iunge([RADIX_AGENTIUM, "runs"])
fixum VIA_REPOSITORIORUM = solum.iunge([RADIX_AGENTIUM, "repos"])
fixum VIA_PERSONARUM = solum.iunge([RADIX_AGENTIUM, "personas"])

functio viaMuneris(textus identi) -> textus {
    custodi { si non identi iacit "Job ID required" }
    redde solum.iunge([VIA_MUNERUM, identi])
}

functio viaDomus(textus identi) -> textus {
    custodi { si non identi iacit "Job ID required" }
    redde solum.iunge([VIA_MUNERUM, identi, "home"])
}

functio viaLaboris(textus identi) -> textus {
    custodi { si non identi iacit "Job ID required" }
    redde solum.iunge([VIA_MUNERUM, identi, "repo"])
}

functio viaExitus(textus identi) -> textus {
    custodi { si non identi iacit "Job ID required" }
    redde solum.iunge([VIA_MUNERUM, identi, "output.log"])
}

functio viaMetadatorum(textus identi) -> textus {
    custodi { si non identi iacit "Job ID required" }
    redde solum.iunge([VIA_MUNERUM, identi, "run.json"])
}

functio viaNudiRepositorii(textus repositorium) -> textus {
    custodi { si non repositorium iacit "Repository name required" }
    # owner/repo -> owner-repo.git
    redde solum.iunge([VIA_REPOSITORIORUM, repositorium.replace("/", "-") + ".git"])
}

# ═══════════════════════════════════════════════════════════════════════════════
# EXEMPLARES - Model resolution
# ═══════════════════════════════════════════════════════════════════════════════

fixum COMPENDIA_EXEMPLARIUM = {
    "sonnet": "claude-sonnet-4-5",
    "opus": "claude-opus-4-5",
    "haiku": "claude-haiku-4-5",
    "qwen3": "opencode/qwen3-coder",
    "deepseek": "openrouter/deepseek/deepseek-chat-v3.1",
    "gpt4mini": "openrouter/openai/gpt-4o-mini"
}

functio generaIdentem() -> textus {
    redde aleator.uuid().slice(0, 8)
}

functio transferExemplar(textus compendium) -> textus {
    custodi {
        si non compendium vel compendium.trim().length == 0 iacit "Model name required"
    }

    # Full model path (e.g., "openrouter/anthropic/claude-3")
    si compendium.includes("/") reddit compendium

    # Known alias
    si COMPENDIA_EXEMPLARIUM[compendium] reddit COMPENDIA_EXEMPLARIUM[compendium]

    # Unknown alias - warn but allow (might be a new Claude model name)
    mone scriptum("Unknown model alias '§', using as-is", compendium)
    redde compendium
}

functio detegeDorsale(textus exemplar) -> textus {
    redde exemplar.includes("/") sic "opencode" secus "claude"
}

functio generaRamum(textus exemplar, textus identi, si numerus numerusIssue) -> textus {
    fixum issueStr = numerusIssue sic scriptum("issue-§", numerusIssue) secus "task"
    fixum breveExemplar = exemplar.split("/").pop().split("-")[0]
    redde scriptum("§-§-§", issueStr, breveExemplar, identi)
}

# ═══════════════════════════════════════════════════════════════════════════════
# GIT - Repository and worktree operations
# ═══════════════════════════════════════════════════════════════════════════════

functio assecuraNudumRepositorium(textus repositorium) -> vacuum {
    custodi {
        si non repositorium.includes("/") iacit "Repository must be owner/repo format"
    }

    fixum viaNudi = viaNudiRepositorii(repositorium)

    si non solum.exstat(viaNudi) {
        fixum url = scriptum("git@github.com:§.git", repositorium)
        scribe scriptum("Cloning §...", repositorium)
        processus.exsequi(scriptum("git clone --bare § §", url, viaNudi))
    }
    secus {
        scribe "Fetching latest..."
        processus.exsequi(scriptum("cd § && git fetch --all", viaNudi))
    }
}

functio invenitRamusPrincipalis(textus viaNudi) -> textus {
    fixum exitus = processus.exsequiCodem(scriptum("cd § && git show-ref --verify --quiet refs/heads/main", viaNudi))
    redde exitus == 0 sic "main" secus "master"
}

functio creaArborem(textus identi, textus repositorium, textus ramus) -> vacuum {
    fixum viaNudi = viaNudiRepositorii(repositorium)

    custodi {
        si non solum.exstat(viaNudi) iacit scriptum("Bare repository not found at §", viaNudi)
        si non ramus vel ramus.trim().length == 0 iacit "Branch name required"
    }

    fixum viaArboris = viaLaboris(identi)
    fixum ramusPrincipalis = invenitRamusPrincipalis(viaNudi)

    scribe scriptum("Creating worktree (branch: §)...", ramus)
    processus.exsequi(scriptum("cd § && git worktree add -b § § §", viaNudi, ramus, viaArboris, ramusPrincipalis))

    # Constitue originem pro propulsione
    processus.exsequi(scriptum("cd § && git remote add origin git@github.com:§.git", viaArboris, repositorium))
}

# ═══════════════════════════════════════════════════════════════════════════════
# MANDATA - Credential copying to isolated HOME
# ═══════════════════════════════════════════════════════════════════════════════

@ futura
functio copiaMandata(textus destinatioDomus) -> vacuum {
    custodi {
        si non destinatioDomus vel destinatioDomus.trim().length == 0 iacit "Destination HOME directory required"
    }

    fixum veraDomus = solum.domus()

    # Copia .gitconfig si exstat
    fixum viaGitconfig = solum.iunge([veraDomus, ".gitconfig"])
    si solum.exstat(viaGitconfig) {
        cede solum.copia(viaGitconfig, solum.iunge([destinatioDomus, ".gitconfig"]))
    }

    # Copia .ssh directorium (pro git authentificatione)
    fixum viaSsh = solum.iunge([veraDomus, ".ssh"])
    fixum destinatioSsh = solum.iunge([destinatioDomus, ".ssh"])
    si solum.exstat(viaSsh) {
        cede solum.creaDir(destinatioSsh)
        ex ["id_rsa", "id_ed25519", "config", "known_hosts"] pro fasciculus {
            fixum fons = solum.iunge([viaSsh, fasciculus])
            si solum.exstat(fons) {
                cede solum.copia(fons, solum.iunge([destinatioSsh, fasciculus]))
            }
        }
    }

    # Symlink gh CLI configurationem (pro gh authentificatione)
    fixum viaGhConfig = solum.iunge([veraDomus, ".config", "gh"])
    si solum.exstat(viaGhConfig) {
        fixum destinatioConfig = solum.iunge([destinatioDomus, ".config"])
        cede solum.creaDir(destinatioConfig)
        fixum destinatioGh = solum.iunge([destinatioConfig, "gh"])
        si non solum.exstat(destinatioGh) {
            processus.exsequi(scriptum("ln -s § §", viaGhConfig, destinatioGh))
        }
    }

    # Symlink opencode configurationem si exstat
    fixum viaOpencode = solum.iunge([veraDomus, ".local", "share", "opencode"])
    si solum.exstat(viaOpencode) {
        fixum destinatioLocal = solum.iunge([destinatioDomus, ".local", "share"])
        cede solum.creaDir(destinatioLocal)
        fixum destinatioOpencode = solum.iunge([destinatioLocal, "opencode"])
        si non solum.exstat(destinatioOpencode) {
            processus.exsequi(scriptum("ln -s § §", viaOpencode, destinatioOpencode))
        }
    }

    # Crea .zshenv cum tesseris ab ambiente
    varia lista<textus> tesserae = [] innatum lista<textus>
    fixum ghTessera = processus.env("GH_TOKEN")
    si ghTessera {
        tesserae.push(scriptum("export GH_TOKEN=\"§\"", ghTessera))
    }
    fixum githubTessera = processus.env("GITHUB_TOKEN")
    si githubTessera {
        tesserae.push(scriptum("export GITHUB_TOKEN=\"§\"", githubTessera))
    }
    fixum claudeTessera = processus.env("CLAUDE_CODE_OAUTH_TOKEN")
    si claudeTessera {
        tesserae.push(scriptum("export CLAUDE_CODE_OAUTH_TOKEN=\"§\"", claudeTessera))
    }
    si tesserae.length > 0 {
        cede solum.scribe(solum.iunge([destinatioDomus, ".zshenv"]), tesserae.join("\n") + "\n")
    }
}

# ═══════════════════════════════════════════════════════════════════════════════
# PROMPTUM - Prompt assembly
# ═══════════════════════════════════════════════════════════════════════════════

functio componePromptum(textus finis, bivalens habetRepo, bivalens submittePr, si textus contentumPersonae) -> textus {
    varia lista<textus> partes = [] innatum lista<textus>

    # Instructiones personae primum
    si contentumPersonae {
        partes.push(contentumPersonae)
        partes.push("\n---\n")
    }

    # Munus
    partes.push("## Task\n")
    partes.push(finis)

    # Instructiones git
    si habetRepo {
        partes.push("\n\n## Git Instructions\n")
        partes.push("When you have completed your work:")
        partes.push("1. Commit your changes with a clear, descriptive message")
        partes.push("2. Push the branch to origin: `git push -u origin HEAD`")

        si submittePr {
            partes.push("3. Create a pull request using `gh pr create` with:")
            partes.push("   - A clear title summarizing the change")
            partes.push("   - A description explaining what was done and why")
        }
    }

    redde partes.join("\n")
}

# ═══════════════════════════════════════════════════════════════════════════════
# DOMUS - Isolated HOME setup
# ═══════════════════════════════════════════════════════════════════════════════

@ futura
functio praeparaDomusIsolatam(textus identi, textus viaLaborandi, textus finis, bivalens habetRepo, bivalens submittePr, si textus contentumPersonae) -> vacuum {
    custodi {
        si non identi vel identi.trim().length == 0 iacit "Job ID required"
        si non viaLaborandi vel viaLaborandi.trim().length == 0 iacit "Working directory required"
        si non finis vel finis.trim().length == 0 iacit "Task description required"
    }

    fixum domus = viaDomus(identi)

    # Crea .claude directorium
    cede solum.creaDir(solum.iunge([domus, ".claude"]))

    # Compone promptum et scribe AGENTS.md ad directorium laboris
    fixum promptumCompositum = componePromptum(finis, habetRepo, submittePr, contentumPersonae)
    cede solum.scribe(solum.iunge([viaLaborandi, "AGENTS.md"]), promptumCompositum)

    # Symlink .claude/CLAUDE.md -> viaLaborandi/AGENTS.md
    fixum viaAgentium = solum.iunge([viaLaborandi, "AGENTS.md"])
    fixum viaClaudeMd = solum.iunge([domus, ".claude", "CLAUDE.md"])
    processus.exsequi(scriptum("ln -s § §", viaAgentium, viaClaudeMd))

    # Copia mandata
    cede copiaMandata(domus)

    # Scribe settings.json
    fixum configurationes = {
        "permissions": {
            "allow": ["Edit", "Write", "Bash", "Read", "Glob", "Grep", "WebFetch"],
            "defaultMode": "bypassPermissions"
        }
    }
    cede solum.scribe(solum.iunge([domus, ".claude", "settings.json"]), json.solvePulchre(configurationes, 2))
}

# ═══════════════════════════════════════════════════════════════════════════════
# GENERA - Agent spawning
# ═══════════════════════════════════════════════════════════════════════════════

@ futura
functio generaAgentem(textus identi, textus dorsale, textus exemplar, textus finis, textus viaLaborandi) -> numerus {
    # Validate backend tool is available
    custodi {
        si dorsale == "claude" et processus.exsequiCodem("which claude") != 0 iacit "claude CLI not found in PATH"
        si dorsale == "opencode" et processus.exsequiCodem("which opencode") != 0 iacit "opencode CLI not found in PATH"
    }

    fixum domus = viaDomus(identi)
    fixum viaExituum = viaExitus(identi)

    # Build args array for script PTY wrapper
    varia lista<textus> args = ["script", "-q", viaExituum] innatum lista<textus>
    si dorsale == "claude" {
        args = args.concat(["claude", "--model", exemplar, "-p", finis])
    }
    secus {
        args = args.concat(["opencode", "run", "--model", exemplar, scriptum("Follow AGENTS.md. Task: §", finis)])
    }

    # Spawn detached process with isolated HOME, returns PID directly
    redde processus.genera(args, viaLaborandi, { "HOME": domus })
}

# ═══════════════════════════════════════════════════════════════════════════════
# PRINCIPALE - Main run command
# ═══════════════════════════════════════════════════════════════════════════════

@ publica
@ futura
functio runCommand(
    textus finis,
    si textus repositorium,
    si numerus numerusIssue,
    si textus exemplar,
    si textus persona,
    si bivalens pr,
    si numerus tempusMortis,
    si bivalens sineValidatione
) -> vacuum {
    # Validate inputs
    custodi {
        si non finis vel finis.trim().length == 0 iacit "Task description required"
        si repositorium et non repositorium.includes("/") iacit "Repository must be owner/repo format"
        si numerusIssue et numerusIssue <= 0 iacit "Issue number must be positive"
        si tempusMortis et tempusMortis <= 0 iacit "Timeout must be positive"
    }

    # Validate environment
    custodi {
        si processus.exsequiCodem("which git") != 0 iacit "git not found in PATH"
    }

    # Validate persona exists (if specified)
    si persona {
        fixum viaPersonae = solum.iunge([VIA_PERSONARUM, scriptum("§.md", persona)])
        si non solum.exstat(viaPersonae) iacit scriptum("Persona '§' not found at §", persona, viaPersonae)
    }

    fixum identi = generaIdentem()
    fixum exemplarResolutum = transferExemplar(exemplar vel "sonnet")
    fixum dorsale = detegeDorsale(exemplarResolutum)
    fixum ramus = repositorium sic generaRamum(exemplarResolutum, identi, numerusIssue) secus nihil

    scribe scriptum("Creating job §...", identi)
    si persona {
        scribe scriptum("  Persona: §", persona)
    }
    si repositorium {
        scribe scriptum("  Repo: §", repositorium)
        scribe scriptum("  Branch: §", ramus)
        si pr {
            scribe "  PR: enabled"
        }
    }
    si tempusMortis {
        scribe scriptum("  Timeout: §m", tempusMortis)
    }
    scribe scriptum("  Model: § (§)", exemplarResolutum, dorsale)

    # Assecura directoria exstant
    cede solum.creaDir(VIA_MUNERUM)
    cede solum.creaDir(VIA_REPOSITORIORUM)

    varia textus viaLaborandi = ""

    si repositorium {
        # Constitue nudum repositorium et arborem
        assecuraNudumRepositorium(repositorium)
        creaArborem(identi, repositorium, ramus)
        viaLaborandi = viaLaboris(identi)

        # Installa dependentias si package.json exstat
        si solum.exstat(solum.iunge([viaLaborandi, "package.json"])) {
            scribe "Installing dependencies..."
            processus.exsequi(scriptum("cd § && bun install", viaLaborandi))
        }
    }
    secus {
        # Nullum repositorium - utere directorium muneris
        viaLaborandi = viaMuneris(identi)
        cede solum.creaDir(viaLaborandi)
    }

    # Onera contentum personae si specificatum (iam validatum in custodi)
    varia textus contentumPersonae = ""
    si persona {
        fixum viaPersonae = solum.iunge([VIA_PERSONARUM, scriptum("§.md", persona)])
        contentumPersonae = cede solum.lege(viaPersonae)
    }

    # Praepara domum isolatam
    scribe "Setting up isolated HOME..."
    cede praeparaDomusIsolatam(identi, viaLaborandi, finis, nonnihil repositorium, pr vel falsum, contentumPersonae)

    # Genera agentem
    scribe scriptum("Spawning §...", dorsale)
    fixum pid = cede generaAgentem(identi, dorsale, exemplarResolutum, finis, viaLaborandi)

    # Scribe metadata muneris
    fixum nunc = novum Date()
    fixum inceptumAt = nunc.toISOString()
    fixum metadataMuneris = {
        "id": identi,
        "repo": repositorium,
        "issue": numerusIssue,
        "persona": persona,
        "model": exemplarResolutum,
        "branch": ramus,
        "status": "running",
        "pid": pid,
        "startedAt": inceptumAt,
        "timeout": tempusMortis,
        "skipValidation": sineValidatione
    }
    cede solum.scribe(viaMetadatorum(identi), json.solvePulchre(metadataMuneris, 2))

    scribe ""
    scribe scriptum("Job § started (PID §)", identi, pid)
    scribe scriptum("  Watch:    agent jobs watch §", identi)
    scribe scriptum("  Logs:     agent jobs logs §", identi)
    scribe scriptum("  Response: agent jobs response §", identi)
}
